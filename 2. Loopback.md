# FPGA Loopback using Zedboad
Zedboard에서 loopback을 구현해보자.
> Zedboard, Vivado v2018.2 (64-bit), Windows, Putty

***
## 2. Zedboard에 Loopback 구현하기
이 튜토리얼에서는 Vivado에서 제공되는 IP만을 사용하여 전송하는 데이터를 그대로 다시 반환하는 시스템을 구현한다. 이 과정은 5단계로 진행된다.
> Keyword : Loopback, AXI interface, AXI DMA  
> 이 튜토리얼은 이 [사이트](http://www.fpgadeveloper.com/2014/08/using-the-axi-dma-in-vivado.html)에서 소개된 튜토리얼을
대부분 그대로 따라가며, 이 [유튜브 채널](https://www.youtube.com/user/mamsadegh2/feed)에서 설명한 내용을 더하여 만들어졌다.

### 구현할 시스템
<img src="./img/2.0.1.PNG" width="500px">[출처](http://www.fpgadeveloper.com/2014/08/using-the-axi-dma-in-vivado.html)  
- Zynq PS: ARM Core와 DDR 메모리 컨트롤러가 포함되어 있다.  
<img src="./img/2.0.2.PNG" width="250px">[출처](https://www.youtube.com/watch?v=tnGzZA5VJ0M)  
- Zynq PL: AXI DMA 및 AXI 데이터 FIFO가 PL에 구현된다.  
- MM2S : Memory-Mapped to Streaming, S2MM : Streaming to Memory-Mapped  

### AXI 통신이란?
PS와 구현한 PL은 AXI 프로토콜 통신으로 이어진다. AXI master port는 트랜잭션을 보내고, AXI slave는 master가 보낸 트랜잭션을 받는다.  
AXI에는 여러 종류의 통신이 있다.
- AXI Lite : 적은 양의 데이터를 송수신할 때 쓰인다.
- AXI : AXI slave 는 데이터 주소 범위를 갖고 있어, master가 slave의 특정 주소에 원하는 데이터를 쓰도록 명령할 수 있다.
- AXI streaming (AXIS) : data flow application에 사용되며 AXI와 달리 주소범위를 지정하지 않는다.

### AXI DMA란?
DMA는 Direct Memory Access를 의미하며 메모리의 한 부분에서 다른 부분으로 데이터를 전송한다.

### Zedboard에 Loopback 구현하기
#### 2.1. RTL Project 생성하기
1. 새로운 RTL Project를 만들고 Flow Navigator - IP Integrator - Open Block Design을 클릭해, **1. Zedboard에 Base System 구현하기** 의 Block Design을 연다.
<img src="./img/2.1.1.PNG" width="400px">  

2. Add IP에서 AXI Direct Memory Access를 더블 클릭하여 추가한다.

3. 블록 디자인 상단 메세지의 Run Connection Automation을 클릭하고 /axi_dma_0/S_AXI_LITE를 선택한다.

4. Block Diagram의 Zynq block을 더블 클릭하고, PS-PL Configuration에서 HP Slave AXI Interface - S AXI HP0 Interface를 Enable한다.  
이 high performance AXI slave interface를 통해 AXI DMA를 연결한다. 

5. 블록 디자인 상단 메세지의 Run Connection Automation을 클릭하고 /processing_system7_0/S_AXI_HP0를 선택한다.

6. 한 번 더 블록 디자인 상단 메세지의 Run Connection Automation을 클릭하고 /axi_dma_0/M_AXI_SG를 선택한다.

7. 한 번 더 블록 디자인 상단 메세지의 Run Connection Automation을 클릭하고 /axi_dma_0/M_AXI_S2MM을 선택한다.

8. Add IP에서 AXI4-Stream Data FIFO를 더블 클릭하여 추가한다.

9. FIFO와 DMA연결하기: FIFO의 `S_AXIS`포트와 AXI DMA의 `M_AXIS_MM2S`포트를 연결하고, FIFO의 `M_AXIS`포트와 AXI DMA의 `S_AXIS_S2MM`포트르 연결한다.

10. FIFO의 clock과 reset을 설정하기: FIFO의 `s_axis_aclk`포트와 DMA의 `s_axi_lite_aclk`포트를 연결하고, FIFO의 `s_axis_aresetn`포트와 DMA의 `axi_resetn`포트를 연결한다.

11. DMA에서 필요하지 않은 포트 제거하기: 블록 디자인에서 DMA를 더블 클릭하여 `Enable Control / Status Stream`옵션을 설정 해제한다.

12. DMA 인터럽트를 PS에 연결하기: 먼저 Zynq PS block을 더블 클릭하여 Interrupts에서 PS-PL Interrupts Ports의 IRQ_F2P[15 :0]를 Enable한다.  

Add IP에서 `Concat`을 더블 클릭하여 추가한다.  

Concat의 `dout`포트와 Zynq PS의 `IRQ_F2P`포트를 연결한다.  

DMA의 `mm2s_introut`포트와 Concat의 `In0`포트를 연결한다.  

DMA의 `s2mm_introut`포트와 Concat의 `In1`포트를 연결한다.  

이로써 모든 Block Design은 끝이 난다.

13.

#### 2.2. Generate Bitstream
#### 2.3. Export hardware to Vivado SDK
#### 2.4. Create a software application
#### 2.5. Test the design on the hardware
